apiVersion: kustomize.config.k8s.io/v1beta1
configMapGenerator:
- behavior: merge
  literals:
  - kustomize.buildOptions=--enable-helm
  - helm.valuesFileSchemes=secrets+gpg-import,secrets+gpg-import-kubernetes,secrets+age-import,secrets+age-import-kubernetes,secrets,http,https
  - |
    repository.credentials=- passwordSecret:
        key: git_token
        name: autopilot-secret
      url: https://github.com/
      usernameSecret:
        key: git_username
        name: autopilot-secret
  - |
    configManagementPlugins=- name: helmfile
      init:
        command: [sh, -c]
        args: ["/usr/local/bin/argo-cd-helmfile.sh init"]
      generate:
        command: [sh, -c]
        args: ["/usr/local/bin/kontemplate template /home/argocd/.local/share/helm",
               "/usr/local/bin/argo-cd-helmfile.sh generate"
               ]
               
  name: argocd-cm
kind: Kustomization
namespace: csdp
patchesStrategicMerge:
- |-
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: argocd-repo-server
  spec:
    template:
      spec:
        containers:
        - name: argocd-repo-server
          env:
          - name: HELM_PLUGINS
            value: /custom-tools/helm-plugins/
          # In case wrapper scripts are used, HELM_SECRETS_HELM_PATH needs to be the path of the real helm binary
          - name: HELM_SECRETS_HELM_PATH
            value: /usr/local/bin/helm
          - name: HELM_SECRETS_SOPS_PATH
            value: /usr/local/bin/sops
          - name: HELM_SECRETS_KUBECTL_PATH
            value: /usr/local/bin/kubectl
          # https://github.com/jkroepke/helm-secrets/wiki/Security-in-shared-environments
          - name: HELM_SECRETS_VALUES_ALLOW_SYMLINKS
            value: "false"
          - name: HELM_SECRETS_VALUES_ALLOW_ABSOLUTE_PATH
            value: "false"
          - name: HELM_SECRETS_VALUES_ALLOW_PATH_TRAVERSAL
            value: "false"
          volumeMounts:
          - mountPath: /usr/local/bin/argo-cd-helmfile.sh
            name: custom-tools
            subPath: argo-cd-helmfile.sh
          - mountPath: /usr/local/bin/helmfile
            name: custom-tools
            subPath: helmfile
          - mountPath: /usr/local/bin/sops
            name: custom-tools
            subPath: sops
          - mountPath: /usr/local/bin/kubectl
            name: custom-tools
            subPath: kubectl
          - mountPath: /usr/local/bin/kontemplate
            name: custom-tools
            subPath: kontemplate                       
          - mountPath: /home/argocd/.local/share/helm
            name: helm-data-home
          - mountPath: /custom-tools
            name: custom-tools
        volumes:
        - name: custom-tools
          emptyDir: {}
        - name: helm-data-home
          emptyDir: {}
        initContainers:
        - name: download-tools
          image: alpine:3.8
          command: [sh, -c]
          env:
          - name: HELM_SECRETS_VERSION
            value: "3.12.0"
          - name: SOPS_VERSION
            value: "3.7.1"
          - name: KUBECTL_VERSION
            value: "1.22.0"
          - name: KONTEMPLATE_RELEASE
            value: "https://github.com/tazjin/kontemplate/releases/download/v1.8.0/kontemplate-1.8.0-6c3b299-linux-amd64.tar.gz"
          args:
            - |
              # helmfile
              wget -qO /custom-tools/argo-cd-helmfile.sh https://raw.githubusercontent.com/travisghansen/argo-cd-helmfile/master/src/argo-cd-helmfile.sh
              chmod +x /custom-tools/argo-cd-helmfile.sh
              wget -qO /custom-tools/helmfile https://github.com/roboll/helmfile/releases/download/v0.138.7/helmfile_linux_amd64
              chmod +x /custom-tools/helmfile
              # helm secrets
              mkdir -p /custom-tools/helm-plugins
              wget -qO- https://github.com/jkroepke/helm-secrets/releases/download/v${HELM_SECRETS_VERSION}/helm-secrets.tar.gz | tar -C /custom-tools/helm-plugins -xzf-;
              wget -qO /custom-tools/sops https://github.com/mozilla/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux
              wget -qO /custom-tools/kubectl https://dl.k8s.io/release/v${KUBECTL_VERSION}/bin/linux/amd64/kubectl
              wget -qO- "${KONTEMPLATE_RELEASE}" | tar -C /custom-tools -xzf-;
              chmod +x /custom-tools/*

          volumeMounts:
            - mountPath: /custom-tools
              name: custom-tools
            - mountPath: /helm/data
              name: helm-data-home
resources:
- github.com/codefresh-io/csdp-official/csdp/hybrid/basic/apps/argo-cd?ref=0.1.17
