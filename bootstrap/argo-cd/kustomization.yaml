apiVersion: kustomize.config.k8s.io/v1beta1
configMapGenerator:
- behavior: merge
  literals:
  - |
    repository.credentials=- passwordSecret:
        key: git_token
        name: autopilot-secret
      url: https://github.com/
      usernameSecret:
        key: git_username
        name: autopilot-secret
  - |
    configManagementPlugins=
    - name: helmfile
      init:
        command: [sh, -c]
        args: 
         - |
            /usr/local/bin/argo-cd-helmfile.sh init
            $(HOME=/tmp aws sts assume-role --role-arn arn:aws:iam::839151377425:role/inc03-argocd-repo-server-sa --role-session-name argocd |\
          jq -r '.Credentials | "export AWS_ACCESS_KEY_ID=\(.AccessKeyId)\nexport AWS_SECRET_ACCESS_KEY=\(.SecretAccessKey)\nexport AWS_SESSION_TOKEN=\(.SessionToken)"')
      generate:
        command: [sh, -c]
        args: 
          - |
            /usr/local/bin/argo-cd-helmfile.sh generate
            helm template --release-name $RELEASE_NAME --values values.yaml --values secrets.yaml .
  name: argocd-cm
kind: Kustomization
namespace: csdp
patchesStrategicMerge:
- |-
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: argocd-repo-server
  spec:
    template:
      spec:
        containers:
        - name: argocd-repo-server
          volumeMounts:
          - mountPath: /usr/local/bin/argo-cd-helmfile.sh
            name: custom-tools
            subPath: argo-cd-helmfile.sh
          - mountPath: /usr/local/bin/helmfile
            name: custom-tools
            subPath: helmfile
           - mountPath: /home/argocd/.local/share/helm
            name: helm-data-home                     
        volumes:
        - name: custom-tools
          emptyDir: {}
        - name: helm-data-home
          emptyDir: {}
        initContainers:
        - name: download-tools
          image: alpine:3.8
          command: [sh, -c]
          args:
            - |
              # helmfile
              wget -qO /custom-tools/argo-cd-helmfile.sh https://raw.githubusercontent.com/travisghansen/argo-cd-helmfile/master/src/argo-cd-helmfile.sh
              chmod +x /custom-tools/argo-cd-helmfile.sh
              wget -qO /custom-tools/helmfile https://github.com/roboll/helmfile/releases/download/v0.138.7/helmfile_linux_amd64
              chmod +x /custom-tools/helmfile
 
          volumeMounts:
            - mountPath: /custom-tools
              name: custom-tools
            - mountPath: /helm/data
              name: helm-data-home
resources:
- github.com/codefresh-io/csdp-official/csdp/hybrid/basic/apps/argo-cd?ref=0.1.19
- argocd-server-ingress.yaml
- repo-server-sa.yaml